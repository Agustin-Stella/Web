<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="assets/css/style-admin.css">
  <title>Panel Admin</title>
</head>
<body>

<h2>Panel de Administraci√≥n</h2>

<!-- Login Simple -->
<div id="login" class="auth-container">
  <h2>Iniciar Sesi√≥n</h2>
  <div class="form-group">
    <label>Contrase√±a:</label>
    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
  </div>
  <button onclick="loginSimple()">Ingresar</button>
  <div id="errorLogin" class="error-message"></div>
</div>

<div id="gestion">
  <div class="user-info">
    <span>üë§ Administrador</span>
    <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
  </div>
  
  <div class="tabs">
    <button class="tab-btn active" onclick="cambiarTab('cargar')">Cargar Producto</button>
    <button class="tab-btn" onclick="cambiarTab('gestionar')">Gestionar Productos</button>
  </div>
  
  <!-- TAB: CARGAR PRODUCTO -->
  <div id="tab-cargar" class="tab-content active">
    <div id="form">
      <h3 id="form-title">Agregar Nuevo Producto</h3>
      <input type="hidden" id="productoIdEditar" value="">

      <p>Nombre del producto</p>
      <input type="text" id="nombre">

      <p>Categor√≠a</p>
      <select id="categoria">
        <option value="">Seleccionar categor√≠a</option>
        <option value="AROMATIZANTES-AMBIENTE">AROMATIZANTES-AMBIENTE</option>
        <option value="AROMATIZANTES-AUTOMOTOR">AROMATIZANTES-AUTOMOTOR</option>
        <option value="AROMATIZANTES-TEXTIL">AROMATIZANTES-TEXTIL</option>
        <option value="AUTOMOTOR">AUTOMOTOR</option>
        <option value="BALDES">BALDES</option>
        <option value="BA√ëO">BA√ëO</option>
        <option value="BAZAR">BAZAR</option>
        <option value="BOLSAS">BOLSAS</option>
        <option value="BROCHES">BROCHES</option>
        <option value="CABOS">CABOS</option>
        <option value="CEPILLERIA">CEPILLERIA</option>
        <option value="CESTO">CESTO</option>
        <option value="CESTOS">CESTOS</option>
        <option value="CONTENEDORES">CONTENEDORES</option>
        <option value="ESCOBILLONES">ESCOBILLONES</option>
        <option value="ESPONJA">ESPONJA</option>
        <option value="ESPONJAS">ESPONJAS</option>
        <option value="FUENTONES">FUENTONES</option>
        <option value="GATILLOS">GATILLOS</option>
        <option value="GUANTES">GUANTES</option>
        <option value="JABON-LAVAR">JABON DE LAVAR</option>
        <option value="JARDINERIA">JARDINERIA</option>
        <option value="LAMPAZO">LAMPAZO</option>
        <option value="LAMPAZOS-VARIOS">LAMPAZOS VARIOS</option>
        <option value="LAVAVAJILLA">LAVAVAJILLA</option>
        <option value="LIMPIADOR">LIMPIADOR</option>
        <option value="MANGUERAS">MANGUERAS</option>
        <option value="MOPA">MOPA</option>
        <option value="ORGANIZADOR">ORGANIZADOR</option>
        <option value="PALAS">PALAS</option>
        <option value="PAPEL">PAPEL</option>
        <option value="PA√ëO">PA√ëO</option>
        <option value="PERCHAS">PERCHAS</option>
        <option value="PERFUMERIA">PERFUMERIA</option>
        <option value="PILETA">PILETA</option>
        <option value="PLUMEROS">PLUMEROS</option>
        <option value="QUITAMANCHA">QUITAMANCHA</option>
        <option value="REPASADOR">REPASADOR</option>
        <option value="SAHUMERIOS">SAHUMERIOS</option>
        <option value="SECADOR">SECADOR</option>
        <option value="SECADORES">SECADORES</option>
        <option value="SUAVIZANTES">SUAVIZANTES</option>
        <option value="TENDER">TENDER</option>
        <option value="TEXTIL">TEXTIL</option>
        <option value="TRAPO">TRAPO</option>
      </select>

      <p>Precio</p>
      <input type="number" id="precio" step="0.01">

      <p>URL de la Imagen</p>
      <input type="text" id="imagenUrl" placeholder="https://i.ibb.co/ejemplo.jpg">
      <img id="previewImg" class="preview-image" src="" alt="Preview">

      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="destacado">
          Producto Destacado
        </label>
        <label>
          <input type="checkbox" id="oferta">
          En Oferta
        </label>
      </div>

      <div style="text-align: center;">
        <button id="btnGuardar" onclick="guardarProducto()">Guardar Producto</button>
        <button id="btnCancelar" class="btn-cancelar" onclick="cancelarEdicion()" style="display: none;">Cancelar</button>
      </div>
    </div>
  </div>
  
  <!-- TAB: GESTIONAR PRODUCTOS -->
  <div id="tab-gestionar" class="tab-content">
    <div class="loading" id="loadingProductos">Cargando productos...</div>
    <div id="productosLista"></div>
  </div>
</div>

<script type="module">
  import { db } from "./assets/js/firebase.js";
  import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  // üîê CONTRASE√ëA MAESTRA 
  const MASTER_PASSWORD = "Brondo2025";
  
  let productos = [];
  let isAuthenticated = sessionStorage.getItem('adminAuth') === 'true';

  // Verificar si ya est√° autenticado al cargar la p√°gina
  if(isAuthenticated) {
    mostrarPanel();
  }

  function mostrarPanel() {
    document.getElementById("login").style.display = "none";
    document.getElementById("gestion").style.display = "block";
    document.getElementById("form").style.display = "block";
    cargarProductos();
  }

  function mostrarLogin() {
    document.getElementById("login").style.display = "block";
    document.getElementById("gestion").style.display = "none";
  }

  window.loginSimple = function() {
    const password = document.getElementById("password").value;
    const errorDiv = document.getElementById("errorLogin");
    
    if(!password) {
      errorDiv.textContent = "Ingresa la contrase√±a";
      errorDiv.style.display = "block";
      return;
    }
    
    if(password !== MASTER_PASSWORD) {
      errorDiv.textContent = "Contrase√±a incorrecta";
      errorDiv.style.display = "block";
      document.getElementById("password").value = "";
      return;
    }
    
    errorDiv.style.display = "none";
    sessionStorage.setItem('adminAuth', 'true');
    isAuthenticated = true;
    mostrarPanel();
  }

  window.logout = function() {
    sessionStorage.removeItem('adminAuth');
    isAuthenticated = false;
    document.getElementById("password").value = "";
    mostrarLogin();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const passwordInput = document.getElementById("password");
    if(passwordInput) {
      passwordInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') loginSimple();
      });
    }

    const imagenUrl = document.getElementById("imagenUrl");
    if(imagenUrl) {
      imagenUrl.addEventListener('input', (e) => {
        const url = e.target.value;
        const preview = document.getElementById("previewImg");
        if(url && (url.startsWith('http://') || url.startsWith('https://'))) {
          preview.src = url;
          preview.style.display = 'block';
        } else {
          preview.style.display = 'none';
        }
      });
    }
  });

  window.cambiarTab = function(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    
    if(tab === 'gestionar') {
      cargarProductos();
    }
  }

  window.guardarProducto = async function(){
    if(!isAuthenticated) {
      alert("Debes estar autenticado");
      return;
    }

    const productoId = document.getElementById("productoIdEditar").value;
    const nombre = document.getElementById("nombre").value;
    const categoria = document.getElementById("categoria").value;
    const precio = document.getElementById("precio").value;
    const imagenUrl = document.getElementById("imagenUrl").value;
    const destacado = document.getElementById("destacado").checked;
    const oferta = document.getElementById("oferta").checked;

    if(!nombre || !precio || !imagenUrl) {
      return alert("Completa nombre, precio y URL de imagen");
    }

    if(!imagenUrl.startsWith('http://') && !imagenUrl.startsWith('https://')) {
      return alert("La URL de la imagen debe comenzar con http:// o https://");
    }

    try {
      const productoData = {
        nombre,
        categoria: categoria || "SIN CATEGOR√çA",
        precio: Number(precio),
        imagen: imagenUrl,
        destacado: destacado === true,
        oferta: oferta === true
      };

      if(productoId) {
        // Modo edici√≥n - actualizar producto existente
        const docRef = doc(db, "productos", productoId);
        await updateDoc(docRef, productoData);
        alert("Producto actualizado!");
      } else {
        // Modo agregar - crear nuevo producto
        productoData.fechaCreacion = new Date().toISOString();
        await addDoc(collection(db, "productos"), productoData);
        alert("Producto guardado!");
      }

      // Limpiar formulario
      cancelarEdicion();
      cargarProductos();
    } catch(error) {
      alert("Error al guardar: " + error.message);
      console.error(error);
    }
  }

  async function cargarProductos() {
    if(!isAuthenticated) return;
    
    const lista = document.getElementById("productosLista");
    const loading = document.getElementById("loadingProductos");
    
    if(!lista || !loading) return;
    
    loading.style.display = "block";
    lista.innerHTML = "";
    
    try {
      const querySnap = await getDocs(collection(db, "productos"));
      productos = [];
      
      querySnap.forEach((doc) => {
        productos.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      productos.sort((a, b) => {
        if(a.destacado && !b.destacado) return -1;
        if(!a.destacado && b.destacado) return 1;
        if(a.oferta && !b.oferta) return -1;
        if(!a.oferta && b.oferta) return 1;
        return 0;
      });
      
      loading.style.display = "none";
      
      if(productos.length === 0) {
        lista.innerHTML = "<p>No hay productos cargados</p>";
        return;
      }
      
      productos.forEach(producto => {
        const card = document.createElement("div");
        card.className = "producto-card";
        if(producto.destacado === true) card.classList.add("destacado");
        if(producto.oferta === true) card.classList.add("oferta");
        
        card.innerHTML = `
          <img src="${producto.imagen}" alt="${producto.nombre}" onerror="this.src='https://via.placeholder.com/150?text=Sin+Imagen'">
          <h3>${producto.nombre}</h3>
          <p style="font-size: 12px; color: #666;">${producto.categoria || 'Sin categor√≠a'}</p>
          <p class="precio">$${Number(producto.precio).toLocaleString('es-AR', {minimumFractionDigits: 2})}</p>
          <div class="badges">
            ${producto.destacado === true ? '<span class="badge destacado">DESTACADO</span>' : ''}
            ${producto.oferta === true ? '<span class="badge oferta">OFERTA</span>' : ''}
          </div>
          <button class="btn-destacar" onclick="toggleDestacado('${producto.id}', ${!producto.destacado})">
            ${producto.destacado ? '‚òÖ Quitar Destacado' : '‚òÜ Marcar Destacado'}
          </button>
          <button class="btn-oferta" onclick="toggleOferta('${producto.id}', ${!producto.oferta})">
            ${producto.oferta ? 'Quitar Oferta' : 'Marcar Oferta'}
          </button>
          <button class="btn-editar" onclick="editarProducto('${producto.id}')">
              Editar
          </button>
          <button class="btn-quitar" onclick="eliminarProducto('${producto.id}', '${producto.nombre}')">
            Eliminar
          </button>
        `;
        
        lista.appendChild(card);
      });
      
    } catch(error) {
      loading.style.display = "none";
      lista.innerHTML = `<p>Error al cargar productos: ${error.message}</p>`;
      console.error(error);
    }
  }

  window.toggleDestacado = async function(id, nuevoEstado) {
    if(!isAuthenticated) return alert("Debes estar autenticado");
    
    try {
      const docRef = doc(db, "productos", id);
      await updateDoc(docRef, {
        destacado: nuevoEstado === true
      });
      alert(nuevoEstado ? "Producto marcado como destacado" : "Destacado removido");
      cargarProductos();
    } catch(error) {
      alert("Error: " + error.message);
    }
  }

  window.toggleOferta = async function(id, nuevoEstado) {
    if(!isAuthenticated) return alert("Debes estar autenticado");
    
    try {
      const docRef = doc(db, "productos", id);
      await updateDoc(docRef, {
        oferta: nuevoEstado === true
      });
      alert(nuevoEstado ? "Producto marcado en oferta" : "Oferta removida");
      cargarProductos();
    } catch(error) {
      alert("Error: " + error.message);
    }
  }

  window.eliminarProducto = async function(id, nombre) {
    if(!isAuthenticated) return alert("Debes estar autenticado");

    if(!confirm(`¬øSeguro que deseas eliminar "${nombre}"?`)) return;

    try {
      await deleteDoc(doc(db, "productos", id));
      alert("Producto eliminado");
      cargarProductos();
    } catch(error) {
      alert("Error al eliminar: " + error.message);
    }
  }

  window.editarProducto = function(id) {
    if(!isAuthenticated) return alert("Debes estar autenticado");

    const producto = productos.find(p => p.id === id);
    if(!producto) return alert("Producto no encontrado");

    // Llenar el formulario con los datos del producto
    document.getElementById("productoIdEditar").value = id;
    document.getElementById("nombre").value = producto.nombre || '';
    document.getElementById("categoria").value = producto.categoria || '';
    document.getElementById("precio").value = producto.precio || '';
    document.getElementById("imagenUrl").value = producto.imagen || '';
    document.getElementById("destacado").checked = producto.destacado === true;
    document.getElementById("oferta").checked = producto.oferta === true;

    // Mostrar preview de la imagen
    const previewImg = document.getElementById("previewImg");
    if(producto.imagen) {
      previewImg.src = producto.imagen;
      previewImg.style.display = 'block';
    }

    // Cambiar a modo edici√≥n
    document.getElementById("form-title").textContent = "Editar Producto";
    document.getElementById("btnGuardar").textContent = "Actualizar Producto";
    document.getElementById("btnCancelar").style.display = "inline-block";

    // Cambiar a la pesta√±a de formulario
    cambiarTab('cargar');
  }

  window.cancelarEdicion = function() {
    // Limpiar el formulario
    document.getElementById("productoIdEditar").value = "";
    document.getElementById("nombre").value = "";
    document.getElementById("categoria").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("imagenUrl").value = "";
    document.getElementById("previewImg").style.display = "none";
    document.getElementById("destacado").checked = false;
    document.getElementById("oferta").checked = false;

    // Volver a modo agregar
    document.getElementById("form-title").textContent = "Agregar Nuevo Producto";
    document.getElementById("btnGuardar").textContent = "Guardar Producto";
    document.getElementById("btnCancelar").style.display = "none";
  }
</script>

</body>
</html>
