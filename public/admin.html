<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="assets/css/style-admin.css">
  <title>Panel Admin</title>
</head>
<body>

<h2>Panel de Administraci√≥n</h2>

<!-- Login Simple -->
<div id="login" class="auth-container">
  <h2>Iniciar Sesi√≥n</h2>
  <div class="form-group">
    <label>Contrase√±a:</label>
    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
  </div>
  <button onclick="loginSimple()">Ingresar</button>
  <div id="errorLogin" class="error-message"></div>
</div>

<div id="gestion">
  <div class="user-info">
    <span>üë§ Administrador</span>
    <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
  </div>
  
  <div class="tabs">
    <button class="tab-btn active" onclick="cambiarTab('cargar')">Cargar Producto</button>
    <button class="tab-btn" onclick="cambiarTab('gestionar')">Gestionar Productos</button>
    <button class="tab-btn" onclick="cambiarTab('categorias')">Gestionar Categor√≠as</button>
  </div>
  
  <!-- TAB: CARGAR PRODUCTO -->
  <div id="tab-cargar" class="tab-content active">
    <div id="form">
      <h3 id="form-title">Agregar Nuevo Producto</h3>
      <input type="hidden" id="productoIdEditar" value="">

      <p>Nombre del producto</p>
      <input type="text" id="nombre">

      <p>Categor√≠a</p>
      <select id="categoria">
        <option value="">Seleccionar categor√≠a</option>
      </select>

      <p>Precio</p>
      <input type="number" id="precio" step="0.01">

      <!-- Input para subir archivo -->
      <p>Subir Imagen (Archivo)</p>
      <input type="file" id="archivoImagen" accept="image/*">
      <div id="uploadProgress" style="display: none; margin-top: 5px;">
        <progress id="progressBar" value="0" max="100" style="width: 100%;"></progress>
        <span id="progressText">0%</span>
      </div>

      <p>URL de la Imagen</p>
      <input type="text" id="imagenUrl" placeholder="https://i.ibb.co/ejemplo.jpg">
      <img id="previewImg" class="preview-image" src="" alt="Preview">

      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="destacado">
          Producto Destacado
        </label>
        <label>
          <input type="checkbox" id="oferta">
          En Oferta
        </label>
      </div>

      <div style="text-align: center;">
        <button id="btnGuardar" onclick="guardarProducto()">Guardar Producto</button>
        <button id="btnCancelar" class="btn-cancelar" onclick="cancelarEdicion()" style="display: none;">Cancelar</button>
      </div>
    </div>
  </div>
  
  <!-- TAB: GESTIONAR PRODUCTOS -->
  <div id="tab-gestionar" class="tab-content">
    <div class="loading" id="loadingProductos">Cargando productos...</div>
    <div id="productosLista"></div>
  </div>

  <!-- TAB: GESTIONAR CATEGOR√çAS -->
  <div id="tab-categorias" class="tab-content">
    <div class="categorias-container">
      <!-- Card para agregar categor√≠a -->
      <div class="categoria-card add-card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          <h3>Agregar Nueva Categor√≠a</h3>
        </div>
        <div class="card-body">
          <div class="input-group">
            <input type="text" id="nuevaCategoria" placeholder="Nombre de la categor√≠a (Ej: LIMPIEZA)" class="categoria-input">
            <button onclick="agregarCategoria()" class="btn-add">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Agregar
            </button>
          </div>
        </div>
      </div>

      <!-- Card para listar categor√≠as -->
      <div class="categoria-card list-card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <h3>Categor√≠as Actuales</h3>
          <span class="categoria-count" id="categoriaCount">0</span>
        </div>
        <div class="card-body">
          <div class="loading" id="loadingCategorias">
            <div class="spinner"></div>
            <span>Cargando categor√≠as...</span>
          </div>
          <div id="listaCategorias" class="categorias-grid"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // IMPORTACIONES CORREGIDAS - Una sola vez
  import { db, storage } from "./assets/js/firebase.js";
  import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
  import { ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

  const MASTER_PASSWORD = "Brondo2025";
  
  let productos = [];
  let categorias = [];
  let isAuthenticated = sessionStorage.getItem('adminAuth') === 'true';
  let uploadedImageUrl = null;

  if(isAuthenticated) {
    mostrarPanel();
  }

  function mostrarPanel() {
    document.getElementById("login").style.display = "none";
    document.getElementById("gestion").style.display = "block";
    document.getElementById("form").style.display = "block";
    cargarProductos();
    cargarCategorias();
  }

  function mostrarLogin() {
    document.getElementById("login").style.display = "block";
    document.getElementById("gestion").style.display = "none";
  }

  window.loginSimple = function() {
    const password = document.getElementById("password").value;
    const errorDiv = document.getElementById("errorLogin");
    
    if(!password) {
      errorDiv.textContent = "Ingresa la contrase√±a";
      errorDiv.style.display = "block";
      return;
    }
    
    if(password !== MASTER_PASSWORD) {
      errorDiv.textContent = "Contrase√±a incorrecta";
      errorDiv.style.display = "block";
      document.getElementById("password").value = "";
      return;
    }
    
    errorDiv.style.display = "none";
    sessionStorage.setItem('adminAuth', 'true');
    isAuthenticated = true;
    mostrarPanel();
  }

  window.logout = function() {
    sessionStorage.removeItem('adminAuth');
    isAuthenticated = false;
    document.getElementById("password").value = "";
    mostrarLogin();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const passwordInput = document.getElementById("password");
    if(passwordInput) {
      passwordInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') loginSimple();
      });
    }

    const imagenUrl = document.getElementById("imagenUrl");
    if(imagenUrl) {
      imagenUrl.addEventListener('input', (e) => {
        const url = e.target.value;
        const preview = document.getElementById("previewImg");
        if(url && (url.startsWith('http://') || url.startsWith('https://'))) {
          preview.src = url;
          preview.style.display = 'block';
        } else {
          preview.style.display = 'none';
        }
      });
    }

    const archivoImagen = document.getElementById("archivoImagen");
    if(archivoImagen) {
      archivoImagen.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        if(!file.type.startsWith('image/')) {
          alert('Por favor selecciona un archivo de imagen v√°lido');
          e.target.value = '';
          return;
        }

        const preview = document.getElementById("previewImg");
        const reader = new FileReader();
        reader.onload = (event) => {
          preview.src = event.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);

        await uploadImageToStorage(file);
      });
    }
  });

  async function uploadImageToStorage(file) {
    if(!isAuthenticated) {
      alert("Debes estar autenticado");
      return;
    }

    const progressDiv = document.getElementById("uploadProgress");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    progressDiv.style.display = "block";

    const timestamp = new Date().getTime();
    const fileName = `productos/${timestamp}_${file.name}`;
    const fileRef = storageRef(storage, fileName);

    const uploadTask = uploadBytesResumable(fileRef, file);

    uploadTask.on('state_changed',
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        progressBar.value = progress;
        progressText.textContent = Math.round(progress) + '%';
      },
      (error) => {
        console.error("Error al subir:", error);
        alert("Error al subir la imagen: " + error.message);
        progressDiv.style.display = "none";
      },
      async () => {
        try {
          uploadedImageUrl = await getDownloadURL(uploadTask.snapshot.ref);
          progressText.textContent = "¬°Imagen subida!";
          
          document.getElementById("imagenUrl").value = "";
          
          setTimeout(() => {
            progressDiv.style.display = "none";
            progressBar.value = 0;
            progressText.textContent = "0%";
          }, 2000);
        } catch(error) {
          console.error("Error al obtener URL:", error);
          alert("Error al obtener URL de la imagen");
        }
      }
    );
  }

  window.cambiarTab = function(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    
    if(tab === 'gestionar') {
      cargarProductos();
    } else if(tab === 'categorias') {
      cargarCategorias();
    }
  }

  // FUNCIONES DE CATEGOR√çAS
  async function cargarCategorias() {
    if(!isAuthenticated) return;
    
    const lista = document.getElementById("listaCategorias");
    const loading = document.getElementById("loadingCategorias");
    const countBadge = document.getElementById("categoriaCount");
    const selectCategoria = document.getElementById("categoria");
    
    if(!lista || !loading) return;
    
    loading.style.display = "flex";
    lista.innerHTML = "";
    
    try {
      const docSnap = await getDocs(collection(db, "configuracion"));
      
      let categoriasData = [];
      docSnap.forEach((documento) => {
        if(documento.id === "categorias") {
          categoriasData = documento.data().lista || [];
        }
      });
      
      categorias = categoriasData.sort();
      
      loading.style.display = "none";
      
      if(countBadge) {
        countBadge.textContent = categorias.length;
      }
      
      selectCategoria.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
      categorias.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        selectCategoria.appendChild(option);
      });
      
      if(categorias.length === 0) {
        lista.innerHTML = `
          <div class="empty-categorias">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <p>No hay categor√≠as creadas a√∫n</p>
          </div>
        `;
        return;
      }
      
      categorias.forEach(categoria => {
        const catDiv = document.createElement("div");
        catDiv.className = "categoria-item";
        catDiv.innerHTML = `
          <span class="categoria-nombre">${categoria}</span>
          <button onclick="eliminarCategoria('${categoria}')" class="btn-eliminar-categoria">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
            Eliminar
          </button>
        `;
        lista.appendChild(catDiv);
      });
      
    } catch(error) {
      loading.style.display = "none";
      lista.innerHTML = `
        <div class="empty-categorias">
          <p style="color: #ef4444;">Error al cargar categor√≠as: ${error.message}</p>
        </div>
      `;
      console.error(error);
    }
  }

  window.agregarCategoria = async function() {
    if(!isAuthenticated) return alert("Debes estar autenticado");
    
    const input = document.getElementById("nuevaCategoria");
    const nombreCategoria = input.value.trim().toUpperCase();
    
    if(!nombreCategoria) {
      return alert("Ingresa un nombre para la categor√≠a");
    }
    
    if(categorias.includes(nombreCategoria)) {
      return alert("Esta categor√≠a ya existe");
    }
    
    try {
      const nuevasCategorias = [...categorias, nombreCategoria].sort();
      
      await setDoc(doc(db, "configuracion", "categorias"), {
        lista: nuevasCategorias
      });
      
      alert("Categor√≠a agregada correctamente");
      input.value = "";
      cargarCategorias();
    } catch(error) {
      alert("Error al agregar categor√≠a: " + error.message);
      console.error(error);
    }
  }

  window.eliminarCategoria = async function(categoria) {
    if(!isAuthenticated) return alert("Debes estar autenticado");
    
    if(!confirm(`¬øSeguro que deseas eliminar la categor√≠a "${categoria}"?\n\nNota: Los productos con esta categor√≠a no ser√°n eliminados.`)) {
      return;
    }
    
    try {
      const nuevasCategorias = categorias.filter(cat => cat !== categoria);
      
      await setDoc(doc(db, "configuracion", "categorias"), {
        lista: nuevasCategorias
      });
      
      alert("Categor√≠a eliminada correctamente");
      cargarCategorias();
    } catch(error) {
      alert("Error al eliminar categor√≠a: " + error.message);
      console.error(error);
    }
  }

  window.guardarProducto = async function(){
    if(!isAuthenticated) {
      alert("Debes estar autenticado");
      return;
    }

    const productoId = document.getElementById("productoIdEditar").value;
    const nombre = document.getElementById("nombre").value;
    const categoria = document.getElementById("categoria").value;
    const precio = document.getElementById("precio").value;
    const imagenUrl = document.getElementById("imagenUrl").value;
    const destacado = document.getElementById("destacado").checked;
    const oferta = document.getElementById("oferta").checked;

    const imagenFinal = uploadedImageUrl || imagenUrl;

    if(!nombre || !precio || !imagenFinal) {
      return alert("Completa nombre, precio y URL de imagen");
    }

    if(!imagenFinal.startsWith('http://') && !imagenFinal.startsWith('https://')) {
      return alert("La URL de la imagen debe comenzar con http:// o https://");
    }

    try {
      const productoData = {
        nombre,
        categoria: categoria || "SIN CATEGOR√çA",
        precio: Number(precio),
        imagen: imagenFinal,
        destacado: destacado === true,
        oferta: oferta === true
      };

      if(productoId) {
        const docRef = doc(db, "productos", productoId);
        await updateDoc(docRef, productoData);
        alert("Producto actualizado!");
      } else {
        productoData.fechaCreacion = new Date().toISOString();
        await addDoc(collection(db, "productos"), productoData);
        alert("Producto guardado!");
      }

      cancelarEdicion();
      cargarProductos();
    } catch(error) {
      alert("Error al guardar: " + error.message);
      console.error(error);
    }
  }

  async function cargarProductos() {
    if(!isAuthenticated) return;
    
    const lista = document.getElementById("productosLista");
    const loading = document.getElementById("loadingProductos");
    
    if(!lista || !loading) return;
    
    loading.style.display = "block";
    lista.innerHTML = "";
    
    try {
      const querySnap = await getDocs(collection(db, "productos"));
      productos = [];
      
      querySnap.forEach((doc) => {
        productos.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      productos.sort((a, b) => {
        if(a.destacado && !b.destacado) return -1;
        if(!a.destacado && b.destacado) return 1;
        if(a.oferta && !b.oferta) return -1;
        if(!a.oferta && b.oferta) return 1;
        return 0;
      });
      
      loading.style.display = "none";
      
      if(productos.length === 0) {
        lista.innerHTML = "<p>No hay productos cargados</p>";
        return;
      }
      
      productos.forEach(producto => {
        const card = document.createElement("div");
        card.className = "producto-card";
        if(producto.destacado === true) card.classList.add("destacado");
        if(producto.oferta === true) card.classList.add("oferta");
        
        card.innerHTML = `
          <img src="${producto.imagen}" alt="${producto.nombre}" onerror="this.src='https://via.placeholder.com/150?text=Sin+Imagen'">
          <h3>${producto.nombre}</h3>
          <p style="font-size: 12px; color: #666;">${producto.categoria || 'Sin categor√≠a'}</p>
          <p class="precio">$${Number(producto.precio).toLocaleString('es-AR', {minimumFractionDigits: 2})}</p>
          <div class="badges">
            ${producto.destacado === true ? '<span class="badge destacado">DESTACADO</span>' : ''}
            ${producto.oferta === true ? '<span class="badge oferta">OFERTA</span>' : ''}
          </div>
          <button class="btn-destacar" onclick="toggleDestacado('${producto.id}', ${!producto.destacado})">
            ${producto.destacado ? '‚òÖ Quitar Destacado' : '‚òÜ Marcar Destacado'}
          </button>
          <button class="btn-oferta" onclick="toggleOferta('${producto.id}', ${!producto.oferta})">
            ${producto.oferta ? 'Quitar Oferta' : 'Marcar Oferta'}
          </button>
          <button class="btn-editar" onclick="editarProducto('${producto.id}')">
              Editar
          </button>
          <button class="btn-quitar" onclick="eliminarProducto('${producto.id}', '${producto.nombre}')">
            Eliminar
          </button>
        `;
        
        lista.appendChild(card);
      });
      
    } catch(error) {
      loading.style.display = "none";
      lista.innerHTML = `<p>Error al cargar productos: ${error.message}</p>`;
      console.error(error);
    }
  }

  window.toggleDestacado = async function(id, nuevoEstado) {
    if(!isAuthenticated) return alert("Debes estar autenticado");
    
    try {
      const docRef = doc(db, "productos", id);
      await updateDoc(docRef, {
        destacado: nuevoEstado === true
      });
      alert(nuevoEstado ? "Producto marcado como destacado" : "Destacado removido");
      cargarProductos();
    } catch(error) {
      alert("Error: " + error.message);
    }
  }

  window.toggleOferta = async function(id, nuevoEstado) {
    if(!isAuthenticated) return alert("Debes estar autenticado");
    
    try {
      const docRef = doc(db, "productos", id);
      await updateDoc(docRef, {
        oferta: nuevoEstado === true
      });
      alert(nuevoEstado ? "Producto marcado en oferta" : "Oferta removida");
      cargarProductos();
    } catch(error) {
      alert("Error: " + error.message);
    }
  }

  window.eliminarProducto = async function(id, nombre) {
    if(!isAuthenticated) return alert("Debes estar autenticado");

    if(!confirm(`¬øSeguro que deseas eliminar "${nombre}"?`)) return;

    try {
      await deleteDoc(doc(db, "productos", id));
      alert("Producto eliminado");
      cargarProductos();
    } catch(error) {
      alert("Error al eliminar: " + error.message);
    }
  }

  window.editarProducto = function(id) {
    if(!isAuthenticated) return alert("Debes estar autenticado");

    const producto = productos.find(p => p.id === id);
    if(!producto) return alert("Producto no encontrado");

    document.getElementById("productoIdEditar").value = id;
    document.getElementById("nombre").value = producto.nombre || '';
    document.getElementById("categoria").value = producto.categoria || '';
    document.getElementById("precio").value = producto.precio || '';
    document.getElementById("imagenUrl").value = producto.imagen || '';
    document.getElementById("destacado").checked = producto.destacado === true;
    document.getElementById("oferta").checked = producto.oferta === true;

    const previewImg = document.getElementById("previewImg");
    if(producto.imagen) {
      previewImg.src = producto.imagen;
      previewImg.style.display = 'block';
    }

    document.getElementById("form-title").textContent = "Editar Producto";
    document.getElementById("btnGuardar").textContent = "Actualizar Producto";
    document.getElementById("btnCancelar").style.display = "inline-block";

    cambiarTab('cargar');
  }

  window.cancelarEdicion = function() {
    document.getElementById("productoIdEditar").value = "";
    document.getElementById("nombre").value = "";
    document.getElementById("categoria").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("imagenUrl").value = "";
    document.getElementById("previewImg").style.display = "none";
    document.getElementById("destacado").checked = false;
    document.getElementById("oferta").checked = false;
    document.getElementById("archivoImagen").value = "";
    uploadedImageUrl = null;

    document.getElementById("form-title").textContent = "Agregar Nuevo Producto";
    document.getElementById("btnGuardar").textContent = "Guardar Producto";
    document.getElementById("btnCancelar").style.display = "none";
  }
</script>

</body>
</html>
